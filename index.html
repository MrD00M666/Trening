<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dark Training Calendar</title>
    <!-- Подключение Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* Dark Theme Palette */
            --primary: #bb86fc; /* Фиолетовый акцент */
            --primary-dark: #3700b3;
            --bg: #121212;      /* Очень темный фон */
            --surface: #1e1e1e; /* Фон карточек */
            --text: #e0e0e0;    /* Светлый текст */
            --gray: #333333;    /* Границы */
            
            /* Colors for workout types (Slightly muted for dark mode) */
            --strength: #cf6679;
            --cardio: #03dac6;
            --yoga: #f1c40f;
            --rest: #95a5a6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            width: 100%;
            max-width: 600px; /* Оптимизация под мобилки */
            background: var(--surface);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            overflow: hidden;
            min-height: 90vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #2c2c2c;
            border-bottom: 1px solid var(--gray);
        }

        .header button {
            background: var(--gray);
            border: none;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        /* Settings Icon */
        .settings-btn {
            background: none !important;
            font-size: 20px !important;
        }

        /* Calendar Grid */
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #252525;
            padding: 10px 0;
            text-align: center;
            font-size: 14px;
            color: #888;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            padding: 5px;
            gap: 5px;
        }

        .day {
            min-height: 60px;
            background: #2c2c2c;
            border-radius: 6px;
            padding: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .day.current-day {
            border: 1px solid var(--primary);
            background: #322a38;
        }

        .day-number {
            font-size: 12px;
            color: #888;
            margin-bottom: 2px;
        }
        
        .day.current-day .day-number {
            color: var(--primary);
            font-weight: bold;
        }

        .day.padding {
            background-color: transparent;
            cursor: default;
        }

        /* Workout Label */
        .event {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            color: #121212; /* Темный текст на цветных плашках */
            font-weight: bold;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: var(--surface);
            padding: 20px;
            border-radius: 15px;
            width: 85%;
            max-width: 350px;
            border: 1px solid var(--gray);
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--text);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #aaa;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            background: #2c2c2c;
            border: 1px solid var(--gray);
            color: var(--text);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px; /* Чтобы не зумилось на айфоне */
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-save { background: var(--primary); color: #000; }
        .btn-delete { background: var(--strength); color: #000; }
        .btn-cancel { background: var(--gray); color: #fff; }

        /* Status Bar */
        #status {
            text-align: center;
            font-size: 12px;
            padding: 5px;
            color: #666;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <button class="settings-btn" id="settingsBtn">⚙️</button>
        <button id="prevBtn">&#10094;</button>
        <h2 id="monthDisplay"></h2>
        <button id="nextBtn">&#10095;</button>
    </div>
    <div id="status">Готов к работе</div>

    <div class="weekdays">
        <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>
    </div>

    <div class="days" id="calendar"></div>
</div>

<!-- Workout Modal -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h3>Тренировка</h3>
        <div class="form-group">
            <label>Тип</label>
            <select id="workoutType">
                <option value="strength">Силовая</option>
                <option value="cardio">Кардио</option>
                <option value="yoga">Йога</option>
                <option value="rest">Отдых</option>
            </select>
        </div>
        <div class="form-group">
            <label>Описание</label>
            <textarea id="workoutDesc" rows="3"></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn-delete" id="deleteBtn">Удалить</button>
            <button class="btn-cancel" id="cancelBtn">Отмена</button>
            <button class="btn-save" id="saveBtn">ОК</button>
        </div>
    </div>
</div>

<!-- Settings Modal (GitHub Token) -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3>Настройки GitHub</h3>
        <p style="font-size: 12px; color: #888;">Введите Personal Access Token (Classic), чтобы сохранять данные в репозиторий.</p>
        <div class="form-group">
            <label>GitHub Token (ghp_...)</label>
            <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="document.getElementById('settingsModal').style.display='none'">Закрыть</button>
            <button class="btn-save" onclick="saveSettings()">Сохранить</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const REPO_OWNER = 'MrD00M666';
    const REPO_NAME = 'Trening';
    const FILE_PATH = 'data.json'; // Файл будет создан автоматически
    // ---------------------

    let nav = 0;
    let clicked = null;
    let events = [];
    let ghToken = localStorage.getItem('gh_token') || '';
    let fileSha = null; // Нужен для обновления файла на GitHub

    // Telegram Init
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();
    
    // Цвет хедера в телеге
    tg.setHeaderColor('#1e1e1e');
    tg.setBackgroundColor('#121212');

    const calendar = document.getElementById('calendar');
    const modal = document.getElementById('modal');
    const settingsModal = document.getElementById('settingsModal');
    const monthDisplay = document.getElementById('monthDisplay');
    const statusDiv = document.getElementById('status');

    // --- GITHUB SYNC FUNCTIONS ---
    
    // Кодировка UTF-8 в Base64 (чтобы русский язык не ломался)
    function utf8_to_b64(str) {
        return window.btoa(unescape(encodeURIComponent(str)));
    }

    function b64_to_utf8(str) {
        return decodeURIComponent(escape(window.atob(str)));
    }

    async function loadFromGitHub() {
        if (!ghToken) {
            statusDiv.innerText = 'Токен не настроен. Данные локальные.';
            events = JSON.parse(localStorage.getItem('workouts') || '[]');
            loadCalendar();
            return;
        }

        statusDiv.innerText = 'Загрузка из GitHub...';
        try {
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: {
                    'Authorization': `token ${ghToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    // Добавляем timestamp чтобы избежать кеширования
                    'If-None-Match': '' 
                }
            });

            if (response.status === 404) {
                statusDiv.innerText = 'Файл не найден. Будет создан новый.';
                events = [];
            } else if (response.ok) {
                const data = await response.json();
                fileSha = data.sha;
                const content = b64_to_utf8(data.content.replace(/\n/g, ''));
                events = JSON.parse(content);
                statusDiv.innerText = 'Синхронизировано с GitHub';
            } else {
                throw new Error('Ошибка доступа');
            }
        } catch (e) {
            statusDiv.innerText = 'Ошибка сети или токена';
            console.error(e);
            // Fallback to local
            events = JSON.parse(localStorage.getItem('workouts') || '[]');
        }
        loadCalendar();
    }

    async function saveToGitHub() {
        // Сначала сохраняем локально
        localStorage.setItem('workouts', JSON.stringify(events));

        if (!ghToken) {
            statusDiv.innerText = 'Сохранено локально (нет токена)';
            return;
        }

        statusDiv.innerText = 'Сохранение в облако...';
        
        const contentBase64 = utf8_to_b64(JSON.stringify(events, null, 2));
        
        const body = {
            message: "Update workouts via Telegram App",
            content: contentBase64,
            branch: "main"
        };

        if (fileSha) {
            body.sha = fileSha;
        }

        try {
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${ghToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (response.ok) {
                const data = await response.json();
                fileSha = data.content.sha;
                statusDiv.innerText = 'Успешно сохранено в GitHub!';
                
                // Вибрация при успехе (Telegram feature)
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            } else {
                const err = await response.json();
                statusDiv.innerText = 'Ошибка сохранения: ' + err.message;
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            }
        } catch (e) {
            statusDiv.innerText = 'Ошибка сети';
        }
    }

    // --- CALENDAR LOGIC ---

    function loadCalendar() {
        const dt = new Date();
        if (nav !== 0) dt.setMonth(new Date().getMonth() + nav);

        const month = dt.getMonth();
        const year = dt.getFullYear();
        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const dateString = firstDayOfMonth.toLocaleDateString('ru-RU', {
            weekday: 'short', year: 'numeric', month: 'numeric', day: 'numeric'
        });
        
        let paddingDays = firstDayOfMonth.getDay() - 1;
        if (paddingDays === -1) paddingDays = 6;

        let monthName = dt.toLocaleDateString('ru-RU', { month: 'long' });
        monthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        monthDisplay.innerText = `${monthName} ${year}`;

        calendar.innerHTML = '';

        for(let i = 1; i <= paddingDays + daysInMonth; i++) {
            const daySquare = document.createElement('div');
            daySquare.classList.add('day');
            
            if (i > paddingDays) {
                const dayNum = i - paddingDays;
                const currentMonthStr = String(month + 1).padStart(2, '0');
                const currentDayStr = String(dayNum).padStart(2, '0');
                const fullDate = `${year}-${currentMonthStr}-${currentDayStr}`;

                daySquare.innerHTML = `<span class="day-number">${dayNum}</span>`;
                
                if (nav === 0 && dayNum === new Date().getDate()) {
                    daySquare.classList.add('current-day');
                }

                // Find events
                const eventForDay = events.find(e => e.date === fullDate);
                if (eventForDay) {
                    const div = document.createElement('div');
                    div.classList.add('event');
                    div.innerText = eventForDay.title;
                    
                    const type = eventForDay.type;
                    div.style.backgroundColor = `var(--${type})`;
                    if(type === 'rest') div.style.color = '#000';
                    
                    daySquare.appendChild(div);
                }

                daySquare.addEventListener('click', () => openModal(fullDate));
            } else {
                daySquare.classList.add('padding');
            }
            calendar.appendChild(daySquare);
        }
    }

    function openModal(date) {
        clicked = date;
        const event = events.find(e => e.date === clicked);
        
        if (event) {
            document.getElementById('deleteBtn').style.display = 'block';
            document.getElementById('workoutType').value = event.type;
            document.getElementById('workoutDesc').value = event.title;
        } else {
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('workoutType').value = 'strength';
            document.getElementById('workoutDesc').value = '';
        }
        modal.style.display = 'flex';
    }

    function closeModal() {
        modal.style.display = 'none';
        loadCalendar();
    }

    function saveEvent() {
        const title = document.getElementById('workoutDesc').value;
        const type = document.getElementById('workoutType').value;

        if (title) {
            events = events.filter(e => e.date !== clicked);
            events.push({ date: clicked, title: title, type: type });
            saveToGitHub();
            closeModal();
        }
    }

    function deleteEvent() {
        events = events.filter(e => e.date !== clicked);
        saveToGitHub();
        closeModal();
    }

    function saveSettings() {
        const token = document.getElementById('ghToken').value.trim();
        if(token) {
            localStorage.setItem('gh_token', token);
            ghToken = token;
            settingsModal.style.display = 'none';
            loadFromGitHub();
        }
    }

    // Button Listeners
    document.getElementById('nextBtn').addEventListener('click', () => { nav++; loadCalendar(); });
    document.getElementById('prevBtn').addEventListener('click', () => { nav--; loadCalendar(); });
    document.getElementById('saveBtn').addEventListener('click', saveEvent);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    document.getElementById('deleteBtn').addEventListener('click', deleteEvent);
    document.getElementById('settingsBtn').addEventListener('click', () => {
        document.getElementById('ghToken').value = ghToken;
        settingsModal.style.display = 'flex';
    });

    // Initial Load
    loadFromGitHub();

</script>

</body>
</html>
